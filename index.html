<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>MIDImyFACE - Detección de Gestos Faciales</title>
    <style>
body {
    background-color: black;
    color: lime;
    font-family: 'Courier New', Courier, monospace;
    margin: 0;
    overflow-y: auto; 
    overflow-x: hidden; 
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    min-height: 100vh; 
}

#header {
    margin-top: 10px;
    text-align: center;
}

#title {
    font-size: 24px;
    margin: 0;
}

#subtitle {
    font-size: 14px;
    color: gray;
    margin: 0;
}

#videoContainer {
    width: 90vw;
    height: 50vh; 
    aspect-ratio: 16 / 9;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid lime;
    overflow: hidden;
    position: relative;
    margin: 10px auto; 
}

canvas {
    position: absolute;
    z-index: 100;
    top: 0;
    left: 0;
}

.info-container {
    margin-top: 10px;
    text-align: center;
}

#detectedGesture {
    font-size: 20px;
    color: lime;
    margin-bottom: 5px;
}

.gesture-controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 20px;
    gap: 15px;
    width: 90%;
    max-width: 800px;
}

.gesture-row {
    display: flex;
    align-items: center;
    gap: 5px;
    color: lime;
    flex-wrap: wrap;
}

.gesture-name {
    font-size: 16px;
    width: 120px;
    text-align: right;
}

.gesture-value {
    font-size: 16px;
    width: 80px;
    text-align: left;
}

.input-range {
    width: 50px;
    background-color: black;
    color: lime;
    border: 1px solid lime;
    text-align: center;
}

.toggle-button {
    padding: 5px 10px;
    border: 1px solid lime;
    background-color: black;
    color: lime;
    cursor: pointer;
    transition: all 0.3s;
}

.toggle-button.active {
    background-color: lime;
    color: black;
}

.dropdown {
    background-color: black;
    color: lime;
    border: 1px solid lime;
    padding: 5px;
}

.dropdown option {
    background-color: black;
    color: lime;
}

.cc-display {
    font-size: 14px;
    color: gray;
    width: 60px;
    text-align: center;
}

.midi-status {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: red;
}

.mode-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
}

.mode-button {
    padding: 5px 10px;
    border: 1px solid lime;
    background-color: black;
    color: lime;
    cursor: pointer;
    transition: all 0.3s;
}

.mode-button.active {
    background-color: lime;
    color: black;
}

.theremin-mode,
.percussion-options {
    display: none;
}

.theremin-mode.active,
.percussion-options.active {
    display: block;
}

.theremin-option {
    margin-top: 10px;
}

.theremin-suboptions {
    margin-left: 20px;
    margin-top: 5px;
}

.scale-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 20px;
    flex-wrap: wrap;
    justify-content: space-between;
    width: 90%;
    max-width: 800px;
}


.slider-container {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    justify-content: center;
    flex-wrap: nowrap;
}

.slider {
    width: 200px;
    background-color: black;
    appearance: none;
    height: 4px;
    outline: none;
}

.slider::-webkit-slider-runnable-track {
    background-color: lime;
    height: 4px;
}

.slider::-webkit-slider-thumb {
    appearance: none;
    width: 15px;
    height: 15px;
    background-color: lime;
    border-radius: 50%;
    cursor: pointer;
    margin-top: -6px;
}

.slider::-moz-range-track {
    background-color: lime;
    height: 4px;
}

.slider::-moz-range-thumb {
    width: 15px;
    height: 15px;
    background-color: lime;
    border-radius: 50%;
    cursor: pointer;
}

/* Caja de valor */
.duration-display {
    width: 80px;
    background-color: black;
    color: lime;
    border: 1px solid lime;
    text-align: center;
    font-size: 14px;
    padding: 5px;
    font-family: 'Courier New', Courier, monospace;
}

/* Estilos para la sección de Envolvente */
.envelope-controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 20px;
    gap: 15px;
    width: 90%;
    max-width: 800px;
}

/* Estilos para el botón de instrucciones y presentación */
#instructionButton,
#presentationModeButton {
    margin-top: 10px;
    padding: 5px 10px;
    border: 1px solid lime;
    background-color: black;
    color: lime;
    cursor: pointer;
    transition: all 0.3s;
}

/* Estilos para el modal de instrucciones */
#instructionModal {
    display: none;
    position: fixed;
    z-index: 100;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.9);
}

#instructionModalContent {
    background-color: black;
    margin: 5% auto;
    padding: 20px;
    border: 1px solid lime;
    width: 80%;
    color: lime;
    font-size: 16px;
    text-align: left;
    position: relative;
}

#closeModalButton {
    position: absolute;
    top: 10px;
    right: 10px;
    color: lime;
    background-color: black;
    border: none;
    font-size: 20px;
    cursor: pointer;
}

#presentationOverlay {
    display: none;
    position: fixed;
    z-index: 90; 
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8); 
}

#closePresentationButton {
    position: absolute;
    top: 10px;
    right: 10px;
    color: lime;
    background-color: black;
    border: none;
    font-size: 20px;
    cursor: pointer;
    z-index: 101;
}


.hidden {
    display: none !important;
}


@media (max-width: 768px) {
    #videoContainer {
        width: 100%;
        height: 40vh;
    }
    .gesture-controls, .scale-controls, .envelope-controls {
        width: 100%;
    }
    .slider {
        width: 150px;
    }
}

.presentation-active #videoContainer, .presentation-active canvas {
    width: 100vw;
    height: 100vh;
}
    </style>
</head>

<body>

    <div id="header">
        <h1 id="title">MIDImyFACE</h1>
        <p id="subtitle">by ricardoarbiza 2024 | ricardoarbiza.com</p>
    </div>
<br>
<br>

    <div id="videoContainer">
     
    </div>

   <!-- Controles de Modo -->
   <div class="mode-controls">
    <button id="percussionToggle" class="mode-button">Percusión</button>
    <button id="thereminToggle" class="mode-button">Theremin</button>
</div>
<!-- Opciones de Percusión -->
<div id="percussionOptions" class="percussion-options">
    <select id="percussionModeSelect" class="dropdown">
        <option value="umbral">Umbral</option>
        <option value="automatico">Automático</option>
    </select>
</div>
<!-- Opciones de Theremin -->
<div id="thereminModeOptions" class="theremin-mode">
    <div class="theremin-option">
        <input type="radio" id="thereminSynthOption" name="thereminOption" value="synth">
        <label for="thereminSynthOption">Synth</label>
        <!-- Subopciones de Synth -->
        <div id="thereminSynthOptions" class="theremin-suboptions">
            <label for="waveformSelect">Forma de Onda:</label>
            <select id="waveformSelect" class="dropdown">
                <option value="sine">Sinusoidal</option>
                <option value="square">Cuadrada</option>
                <option value="sawtooth">Sierra</option>
                <option value="triangle">Triangular</option>
            </select>
        </div>
    </div>
    <div class="theremin-option">
        <input type="radio" id="thereminNotesOption" name="thereminOption" value="notas">
        <label for="thereminNotesOption">Notas</label>
        <!-- Subopciones de Notas -->
        <div id="thereminNotesOptions" class="theremin-suboptions">
            <label for="midiInstrumentSelect">Instrumento MIDI:</label>
            <select id="midiInstrumentSelect" class="dropdown">
                <option value="piano">Piano</option>
                <option value="guitar">Guitarra</option>
                <option value="strings">Strings</option>
                <option value="stringSpicatto">S. Spicatto</option>
                <option value="musicBox">Music Box</option>
                <option value="flauta">Flauta</option>
                <option value="pad">Pad</option>
                <option value="marimba">Marimba</option>
                <option value="trumpet">Trompeta</option>
                <option value="bass">Bajo</option>
                <option value="choir">Coro</option>
                <option value="synthesizer">Sintetizador</option>
                <option value="harmonic">Harmonic</option>
            </select>            
        </div>
    </div>
</div>

    <!-- Controles de Gestos -->
    <div class="gesture-controls">
        <!-- Boca -->
        <div class="gesture-row">
            <div class="gesture-name">Boca</div>
            <div class="gesture-value" id="mouthOpenValue">0</div>
            <input type="number" id="mouthOpenMinChange" class="input-range" placeholder="Min Camb">
            <input type="number" id="mouthOpenMin" class="input-range" placeholder="Min">
            <input type="number" id="mouthOpenMax" class="input-range" placeholder="Max">
            <button class="toggle-button" id="mouthOpenScaling">Escalar</button>
            <button class="toggle-button" id="mouthOpenMute">Mute</button>
            <button class="toggle-button" id="mouthOpenSolo">Solo</button>
            <button class="toggle-button" id="mouthOpenControl">Control</button>
            <div class="cc-display" id="mouthOpenCC"></div>
            <button class="toggle-button active" id="mouthOpenNotas">Notas</button>
            <button class="toggle-button" id="mouthOpenDisparador">Disparador</button>
            <input type="number" id="mouthOpenUmbral" class="input-range" placeholder="Umbral">
        </div>

        <!-- Sonrisa -->
        <div class="gesture-row">
            <div class="gesture-name">Sonrisa</div>
            <div class="gesture-value" id="smileValue">0</div>
            <input type="number" id="smileMinChange" class="input-range" placeholder="Min Camb">
            <input type="number" id="smileMin" class="input-range" placeholder="Min">
            <input type="number" id="smileMax" class="input-range" placeholder="Max">
            <button class="toggle-button" id="smileScaling">Escalar</button>
            <button class="toggle-button" id="smileMute">Mute</button>
            <button class="toggle-button" id="smileSolo">Solo</button>
            <button class="toggle-button" id="smileControl">Control</button>
            <div class="cc-display" id="smileCC"></div>
            <button class="toggle-button active" id="smileNotas">Notas</button>
            <button class="toggle-button" id="smileDisparador">Disparador</button>
            <input type="number" id="smileUmbral" class="input-range" placeholder="Umbral">
        </div>

        <!-- Guiño Izq. -->
        <div class="gesture-row">
            <div class="gesture-name">Guiño Izq.</div>
            <div class="gesture-value" id="leftWinkValue">0</div>
            <input type="number" id="leftWinkMinChange" class="input-range" placeholder="Min Camb">
            <input type="number" id="leftWinkMin" class="input-range" placeholder="Min">
            <input type="number" id="leftWinkMax" class="input-range" placeholder="Max">
            <button class="toggle-button" id="leftWinkScaling">Escalar</button>
            <button class="toggle-button" id="leftWinkMute">Mute</button>
            <button class="toggle-button" id="leftWinkSolo">Solo</button>
            <button class="toggle-button" id="leftWinkControl">Control</button>
            <div class="cc-display" id="leftWinkCC"></div>
            <button class="toggle-button active" id="leftWinkNotas">Notas</button>
            <button class="toggle-button" id="leftWinkDisparador">Disparador</button>
            <input type="number" id="leftWinkUmbral" class="input-range" placeholder="Umbral">
        </div>

        <!-- Guiño Der. -->
        <div class="gesture-row">
            <div class="gesture-name">Guiño Der.</div>
            <div class="gesture-value" id="rightWinkValue">0</div>
            <input type="number" id="rightWinkMinChange" class="input-range" placeholder="Min Camb">
            <input type="number" id="rightWinkMin" class="input-range" placeholder="Min">
            <input type="number" id="rightWinkMax" class="input-range" placeholder="Max">
            <button class="toggle-button" id="rightWinkScaling">Escalar</button>
            <button class="toggle-button" id="rightWinkMute">Mute</button>
            <button class="toggle-button" id="rightWinkSolo">Solo</button>
            <button class="toggle-button" id="rightWinkControl">Control</button>
            <div class="cc-display" id="rightWinkCC"></div>
            <button class="toggle-button active" id="rightWinkNotas">Notas</button>
            <button class="toggle-button" id="rightWinkDisparador">Disparador</button>
            <input type="number" id="rightWinkUmbral" class="input-range" placeholder="Umbral">
        </div>

        <!-- Nariz X -->
        <div class="gesture-row">
            <div class="gesture-name">Nariz X</div>
            <div class="gesture-value" id="noseXValue">0</div>
            <input type="number" id="noseXMinChange" class="input-range" placeholder="Min Camb">
            <input type="number" id="noseXMin" class="input-range" placeholder="Min">
            <input type="number" id="noseXMax" class="input-range" placeholder="Max">
            <button class="toggle-button" id="noseXScaling">Escalar</button>
            <button class="toggle-button" id="noseXMute">Mute</button>
            <button class="toggle-button" id="noseXSolo">Solo</button>
            <button class="toggle-button" id="noseXControl">Control</button>
            <div class="cc-display" id="noseXCC"></div>
            <button class="toggle-button active" id="noseXNotas">Notas</button>
            <button class="toggle-button" id="noseXDisparador">Disparador</button>
            <input type="number" id="noseXUmbral" class="input-range" placeholder="Umbral">
        </div>

        <!-- Nariz Y -->
        <div class="gesture-row">
            <div class="gesture-name">Nariz Y</div>
            <div class="gesture-value" id="noseYValue">0</div>
            <input type="number" id="noseYMinChange" class="input-range" placeholder="Min Camb">
            <input type="number" id="noseYMin" class="input-range" placeholder="Min">
            <input type="number" id="noseYMax" class="input-range" placeholder="Max">
            <button class="toggle-button" id="noseYScaling">Escalar</button>
            <button class="toggle-button" id="noseYMute">Mute</button>
            <button class="toggle-button" id="noseYSolo">Solo</button>
            <button class="toggle-button" id="noseYControl">Control</button>
            <div class="cc-display" id="noseYCC"></div>
            <button class="toggle-button active" id="noseYNotas">Notas</button>
            <button class="toggle-button" id="noseYDisparador">Disparador</button>
            <input type="number" id="noseYUmbral" class="input-range" placeholder="Umbral">
        </div>

    <!-- Controles de Escalas (solo para modo Notas) -->
    <div class="scale-controls">
        <div class="scale-label">Escala:</div>
        <select id="scaleSelect" class="dropdown">
            <option value="major" selected>Major</option>
            <option value="minor">Minor</option>
            <option value="dorian">Dorian</option>
            <option value="phrygian">Phrygian</option>
            <option value="lydian">Lydian</option>
            <option value="mixolydian">Mixolydian</option>
            <option value="aeolian">Aeolian</option>
            <option value="locrian">Locrian</option>
            <option value="pentatonic">Pentatonic</option>
            <option value="blues">Blues</option>
            <option value="bebop">Bebop</option>
            <option value="harmonic_minor">Harmonic Minor</option>
            <option value="melodic_minor">Melodic Minor</option>
            <option value="chromatic">Chromatic</option>
        </select>        
        <div class="scale-label">Fundamental:</div>
        <select id="rootNoteSelect" class="dropdown">
            <option value="C">Do</option>
            <option value="C#">Do#</option>
            <option value="D">Re</option>
            <option value="D#">Re#</option>
            <option value="E">Mi</option>
            <option value="F">Fa</option>
            <option value="F#">Fa#</option>
            <option value="G">Sol</option>
            <option value="G#">Sol#</option>
            <option value="A">La</option>
            <option value="A#">La#</option>
            <option value="B">Si</option>
        </select>
    
        <br>
        <br>
        <div class="envelope-controls">
            <h3>Envolvente</h3>
            <!-- Attack -->
            <div class="envelope-row">
                <div class="gesture-name">Attack</div>
                <div class="envelope-value" id="attackValue">0</div>
                <input type="range" id="attackSlider" class="slider" min="0" max="2000" value="100" step="10">
                <button class="toggle-button" id="attackMute">Mute</button>
                <button class="toggle-button" id="attackSolo">Solo</button>
                <button class="toggle-button" id="attackControl">Control</button>
                <div class="cc-display" id="attackCC"></div> <!-- Display for CC value -->
            </div>
            <!-- Decay -->
            <div class="envelope-row">
                <div class="gesture-name">Decay</div>
                <div class="envelope-value" id="decayValue">0</div>
                <input type="range" id="decaySlider" class="slider" min="0" max="2000" value="300" step="10">
                <button class="toggle-button" id="decayMute">Mute</button>
                <button class="toggle-button" id="decaySolo">Solo</button>
                <button class="toggle-button" id="decayControl">Control</button>
                <div class="cc-display" id="decayCC"></div> <!-- Display for CC value -->
            </div>
            <!-- Sustain -->
            <div class="envelope-row">
                <div class="gesture-name">Sustain</div>
                <div class="envelope-value" id="sustainValue">0.5</div>
                <input type="range" id="sustainSlider" class="slider" min="0" max="1" value="0.5" step="0.01">
                <button class="toggle-button" id="sustainMute">Mute</button>
                <button class="toggle-button" id="sustainSolo">Solo</button>
                <button class="toggle-button" id="sustainControl">Control</button>
                <div class="cc-display" id="sustainCC"></div> <!-- Display for CC value -->
            </div>
            <!-- Release -->
            <div class="envelope-row">
                <div class="gesture-name">Release</div>
                <div class="envelope-value" id="releaseValue">500</div>
                <input type="range" id="releaseSlider" class="slider" min="0" max="5000" value="500" step="10">
                <button class="toggle-button" id="releaseMute">Mute</button>
                <button class="toggle-button" id="releaseSolo">Solo</button>
                <button class="toggle-button" id="releaseControl">Control</button>
                <div class="cc-display" id="releaseCC"></div> <!-- Display for CC value -->
            </div>
        </div>        
    </div>

    <!-- MIDI Output Selector -->
    <div class="midi-status">
        <label>Salida MIDI:
            <select id="midiOutputSelect" class="dropdown">
                <option value="">Selecciona la salida MIDI...</option>
            </select>
        </label>
        <div class="status-indicator" id="midiStatusIndicator"></div>
    </div>

    <!-- Botones de Instrucciones y Modo Presentación -->
    <button id="instructionButton">Instrucciones de Uso</button>
    <button id="presentationModeButton">Modo Presentación</button>

    <!-- Modal de Instrucciones -->
    <div id="instructionModal">
        <div id="instructionModalContent">
            <button id="closeModalButton">&times;</button>
            <h2>Instrucciones de Uso</h2>
            <p>
                Este controlador web permite utilizar gestos faciales para generar señales MIDI y controlar instrumentos virtuales, así como generar sonido directamente en el navegador.
            </p>
            <h3>Modos de Uso:</h3>
            <h4>Modo Theremin y Percusión</h4>
            <p>
                En estos modos, puedes escuchar el resultado sonoro directamente en el navegador utilizando la lógica de los gestos.
            </p>
            <h5>Theremin:</h5>
            <p>
                Al activar el modo Theremin, puedes elegir entre dos opciones:
            </p>
            <ul>
                <li><strong>Synth:</strong> Utiliza un oscilador. Puedes seleccionar la forma de onda (sinusoidal, cuadrada, sierra, triangular) y controlar la frecuencia con el gesto de la boca.</li>
                <li><strong>Notas:</strong> Activa automáticamente el botón Notas del gesto Boca. Puedes seleccionar un instrumento MIDI para escuchar. Este modo utiliza la salida MIDI de notas generada por la boca y reproduce los sonidos directamente en el navegador.</li>
            </ul>
            <h5>Percusión:</h5>
            <p>
                Al activar el modo Percusión, todos los botones de Disparador se activan automáticamente. Puedes elegir entre dos modos:
            </p>
            <ul>
                <li><strong>Umbral:</strong> Utiliza el valor configurado en el umbral para activar el disparador de cada gesto.</li>
                <li><strong>Automático:</strong> Detecta cambios repentinos en los valores para activar los sonidos de percusión.</li>
            </ul>
            <h4>Salida MIDI</h4>
            <p>
                Si no están activados los modos Theremin o Percusión, el sistema funciona como un controlador MIDI. Puedes utilizar los gestos para enviar señales MIDI de Control, Notas o Disparadores según las configuraciones establecidas.
            </p>
            <p>
                Ajusta los parámetros de <em>Cambio Mínimo</em>, <em>Escala</em>, y <em>Fundamental</em> para personalizar la respuesta del sistema.
            </p>
            <h3>Funciones de los Gestos:</h3>
            <ul>
                <li><strong>Notas:</strong> Toca notas discretas basadas en el gesto y la escala seleccionada. Las notas se activan al cruzar umbrales ascendentes y se desactivan al descender.</li>
                <li><strong>Control:</strong> Envía valores continuos MIDI CC basados en el gesto.</li>
                <li><strong>Disparador:</strong> Activa eventos cuando el gesto cruza un umbral específico.</li>
            </ul>
            <h3>Ajuste de Valores y Sensibilidad:</h3>
            <p>
                Puedes ajustar el <em>Cambio Mínimo</em> para controlar la sensibilidad de los gestos. Modifica los valores <em>Min</em> y <em>Max</em> para calibrar el rango de detección según tus características faciales.
            </p>
            <h3>Lógica de Activación de Notas:</h3>
            <p>
                En modo Notas, las notas se activan cuando el valor del gesto cruza un umbral en sentido ascendente y se desactivan al descender. Por ejemplo, si el Cambio Mínimo es 10:
            </p>
            <ul>
                <li>Valor sube de 0 a 11: se activa la primera nota.</li>
                <li>Valor sube de 11 a 23: se activa la siguiente nota en la escala.</li>
                <li>Valor desciende por debajo del umbral: la nota se desactiva.</li>
            </ul>
            <p>
                <em>Idea, diseño y programación: Ricardo Arbiza, 2024</em><br>
                Contacto: <a href="mailto:ricardoarbizaroverano@gmail.com">ricardoarbizaroverano at gmail.com</a>
            </p>
        </div>
    </div>

    <!-- Overlay para Modo Presentación -->
    <div id="presentationOverlay">
        <button id="closePresentationButton">&times;</button>
        <!-- Aquí se mostrará la visualización a pantalla completa -->
    </div>

    <!-- Include Libraries and Your Script -->
    <script src="libs/p5.js"></script>
    <script src="libs/face_mesh.js"></script>
    <script src="libs/camera_utils.js"></script>
    <script src="libs/Tone.min.js"></script>    
    <script src="script16.js"></script>
</body>

</html>
